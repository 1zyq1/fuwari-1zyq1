---
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}
const { class: className, style } = Astro.props;

// 增强的IP获取函数 - 支持多种部署环境
function getClientIP(request: Request) {
	try {
		const headers = request.headers;

		// 完整的IP头部列表，按优先级排序
		const ipHeaders = [
			// Cloudflare
			"cf-connecting-ip",
			"true-client-ip",
			"cf-pseudo-ipv4",

			// Vercel
			"x-real-ip",
			"x-vercel-forwarded-for",
			"x-vercel-ip-country",

			// Netlify
			"x-netlify-ip",
			"x-nf-client-connection-ip",

			// AWS / ELB / ALB
			"x-forwarded-for",
			"x-forwarded-host",
			"x-forwarded-proto",
			"x-forwarded-port",

			// 其他常见头部
			"fastly-client-ip",
			"x-client-ip",
			"x-cluster-client-ip",
			"x-original-forwarded-for",

			// 代理服务器
			"forwarded",
			"forwarded-for",
			"via",

			// Akamai
			"akamai-origin-ip",
			"akamai-user-ip",

			// CloudFront
			"cloudfront-viewer-address",
			"cloudfront-viewer-country",

			// Google Cloud
			"x-appengine-user-ip",
			"x-appengine-remote-addr",

			// Azure
			"x-azure-clientip",
			"x-azure-socketip",

			// DigitalOcean
			"do-connecting-ip",

			// Heroku
			"x-heroku-queue-depth",

			// Render
			"x-render-ip",

			// Railway
			"x-railway-ip",

			// Fly.io
			"fly-client-ip",
		];

		console.log("Available headers:", Object.fromEntries(headers.entries()));

		// 特殊处理 x-forwarded-for，它可能包含多个IP
		const xForwardedFor = headers.get("x-forwarded-for");
		if (xForwardedFor) {
			const ips = xForwardedFor
				.split(",")
				.map((ip) => ip.trim())
				.filter((ip) => ip);
			if (ips.length > 0) {
				const clientIP = ips[0];
				console.log("Found IP from x-forwarded-for:", clientIP);
				return clientIP;
			}
		}

		// 检查其他头部
		for (const header of ipHeaders) {
			const value = headers.get(header);
			if (value) {
				console.log(`Found IP from ${header}:`, value);
				// 处理可能包含端口号的IP
				const ip = value.split(":")[0].trim();
				if (ip && ip !== "") {
					// 本地开发环境处理
					if (ip === "::1" || ip === "::ffff:127.0.0.1") return "127.0.0.1";
					return ip;
				}
			}
		}

		// 尝试从 connection.remoteAddress 获取
		try {
			// 注意：这可能在 SSR 中不可用
			const connection = (Astro.request as any).connection;
			const socket = (Astro.request as any).socket;
			const remoteAddress = connection?.remoteAddress || socket?.remoteAddress;

			if (remoteAddress) {
				console.log("Found IP from connection:", remoteAddress);
				const ip = remoteAddress.replace(/^::ffff:/, "");
				if (ip && ip !== "") {
					if (ip === "::1") return "127.0.0.1";
					return ip;
				}
			}
		} catch (e) {
			console.log("Cannot get IP from connection:", e);
		}

		// 如果所有方法都失败，返回部署环境特定的占位符
		if (import.meta.env.PROD) {
			// 生产环境：尝试判断部署平台
			const host = headers.get("host") || "";
			const userAgent = headers.get("user-agent") || "";
			const via = headers.get("via") || "";

			if (host.includes("vercel.app") || headers.get("x-vercel-id")) {
				return "Vercel部署";
			}
			if (headers.get("x-nf-request-id")) {
				return "Netlify部署";
			}
			if (via.includes("cloudfront")) {
				return "CloudFront部署";
			}
			if (headers.get("cf-ray")) {
				return "Cloudflare部署";
			}
			return "生产环境";
		}

		// 开发环境默认值
		return import.meta.env.DEV ? "127.0.0.1" : "未知";
	} catch (error) {
		console.warn("获取IP失败:", error);
		return "获取失败";
	}
}

const userIP = getClientIP(Astro.request);

// 格式化IP显示
function formatIP(ip: string): string {
	if (ip === "127.0.0.1") return "本地环境";
	if (ip.includes("部署")) return ip;
	if (ip === "未知" || ip === "获取失败") return ip;

	// 缩短IPv6地址显示
	if (ip.includes(":")) {
		// 移除IPv4映射的IPv6前缀
		ip = ip.replace(/^::ffff:/, "");
		// 缩短过长的IPv6
		if (ip.length > 20) {
			return ip.replace(/(:0){2,}/, "::").replace(/^::/, "");
		}
	}

	return ip;
}

// 获取IP版本
function getIPVersion(ip: string): string {
	if (
		ip.includes("部署") ||
		ip === "本地环境" ||
		ip === "未知" ||
		ip === "获取失败"
	) {
		return "--";
	}
	return ip.includes(":") ? "IPv6" : "IPv4";
}

// 获取协议类型
function getProtocol(request: Request): string {
	const proto =
		request.headers.get("x-forwarded-proto") ||
		request.headers.get("x-forwarded-protocol") ||
		(request.url.startsWith("https") ? "https" : "http");
	return proto.toUpperCase();
}

const displayIP = formatIP(userIP);
const ipVersion = getIPVersion(userIP);
const protocol = getProtocol(Astro.request);
---

<WidgetLayout name="网络信息" id="ip-info" class:list={[className]} {style}>
	<div class="text-center py-3">
		<div class="flex items-center justify-center gap-2 mb-3">
			<svg class="w-6 h-6 text-neutral-500 dark:text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
			</svg>
			<div class="text-2xl font-bold text-neutral-900 dark:text-neutral-100 font-mono" id="ip-address">{displayIP}</div>
		</div>
		<div class="text-sm text-neutral-500 dark:text-neutral-400">
			当前IP地址
			<span class="text-xs ml-2 opacity-70" id="ip-debug">(点击查看详情)</span>
		</div>
	</div>
	
	<div class="grid grid-cols-2 divide-x divide-neutral-200 dark:divide-neutral-700 text-center pt-3 border-t border-neutral-200 dark:border-neutral-700">
		<div class="px-2">
			<div class="text-lg font-bold text-neutral-900 dark:text-neutral-100 font-mono" id="ip-version">
				{ipVersion}
			</div>
			<div class="text-sm text-neutral-500 dark:text-neutral-400">IP版本</div>
		</div>
		<div class="px-2">
			<div class="text-lg font-bold text-neutral-900 dark:text-neutral-100" id="connection-type">
				<span class="inline-flex items-center">
					{protocol === 'HTTPS' ? (
						<>
							<svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
							</svg>
							<span class="text-green-500">HTTPS</span>
						</>
					) : (
						<>
							<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
							</svg>
							<span>HTTP</span>
						</>
					)}
				</span>
			</div>
			<div class="text-sm text-neutral-500 dark:text-neutral-400">协议类型</div>
		</div>
	</div>
	
	<!-- 调试信息（仅开发环境显示） -->
	{import.meta.env.DEV && (
		<div class="mt-4 pt-4 border-t border-dashed border-neutral-300 dark:border-neutral-700">
			<details class="text-xs">
				<summary class="cursor-pointer text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-300">
					调试信息
				</summary>
				<div class="mt-2 p-2 bg-neutral-100 dark:bg-neutral-800 rounded text-left font-mono overflow-auto">
					<div>原始IP: {userIP}</div>
					<div>格式化后: {displayIP}</div>
					<div>环境: {import.meta.env.MODE}</div>
					<div>URL: {Astro.request.url}</div>
				</div>
			</details>
		</div>
	)}
</WidgetLayout>

<script>
// 客户端IP信息增强
async function enhanceIPInfo() {
	try {
		const ipAddressElement = document.getElementById('ip-address');
		const ipVersionElement = document.getElementById('ip-version');
		const connectionTypeElement = document.getElementById('connection-type');
		const ipDebugElement = document.getElementById('ip-debug');
		
		if (!ipAddressElement) return;
		
		// 获取完整IP地址（从data属性获取原始值）
		const fullIP = ipAddressElement.dataset.originalIp || ipAddressElement.textContent;
		
		// 如果是真实IP（非本地/部署），添加交互功能
		const isRealIP = !fullIP.includes('127.0.0.1') && 
						!fullIP.includes('部署') && 
						fullIP !== '未知' && 
						fullIP !== '获取失败';
		
		if (isRealIP) {
			// 保存原始IP到data属性
			ipAddressElement.dataset.originalIp = fullIP;
			
			// 添加复制功能
			ipAddressElement.classList.add('cursor-pointer', 'hover:text-blue-500', 'dark:hover:text-blue-400', 'transition-colors');
			ipAddressElement.title = '点击复制IP地址';
			
			ipAddressElement.addEventListener('click', async () => {
				try {
					await navigator.clipboard.writeText(fullIP);
					
					// 显示复制成功提示
					const originalText = ipAddressElement.textContent;
					ipAddressElement.textContent = '已复制!';
					ipAddressElement.classList.remove('hover:text-blue-500', 'dark:hover:text-blue-400');
					ipAddressElement.classList.add('text-green-500');
					
					setTimeout(() => {
						ipAddressElement.textContent = originalText;
						ipAddressElement.classList.remove('text-green-500');
						ipAddressElement.classList.add('hover:text-blue-500', 'dark:hover:text-blue-400');
					}, 1500);
				} catch (err) {
					console.error('复制失败:', err);
					// 降级方案：使用execCommand
					const textArea = document.createElement('textarea');
					textArea.value = fullIP;
					document.body.appendChild(textArea);
					textArea.select();
					try {
						document.execCommand('copy');
						ipAddressElement.textContent = '已复制!';
						setTimeout(() => {
							ipAddressElement.textContent = originalText;
						}, 1500);
					} catch (copyErr) {
						console.error('降级复制失败:', copyErr);
					}
					document.body.removeChild(textArea);
				}
			});
			
			// 添加双击获取地理位置功能
			if (ipDebugElement) {
				ipDebugElement.classList.add('cursor-pointer', 'hover:underline');
				ipDebugElement.title = '双击获取地理位置';
				
				let geoData = null;
				ipDebugElement.addEventListener('dblclick', async () => {
					try {
						if (!geoData) {
							ipDebugElement.textContent = '(获取中...)';
							
							// 使用免费的IP API获取地理位置
							const response = await fetch(`https://ipapi.co/${fullIP}/json/`);
							if (response.ok) {
								geoData = await response.json();
								
								// 显示位置信息
								const locationText = geoData.city ? 
									`${geoData.city}, ${geoData.country_name}` : 
									'未知位置';
								
								// 创建位置显示元素
								const locationDiv = document.createElement('div');
								locationDiv.className = 'text-xs text-neutral-500 dark:text-neutral-400 mt-1 animate-fade-in';
								locationDiv.innerHTML = `
									<div class="flex items-center gap-1">
										<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
										</svg>
										<span>${locationText}</span>
									</div>
									${geoData.org ? `<div class="text-xs opacity-75 mt-0.5">${geoData.org}</div>` : ''}
								`;
								
								ipAddressElement.parentElement?.appendChild(locationDiv);
								ipDebugElement.textContent = '(已获取位置)';
								
								// 10秒后移除位置信息
								setTimeout(() => {
									locationDiv.remove();
									ipDebugElement.textContent = '(双击获取位置)';
									geoData = null;
								}, 10000);
							} else {
								ipDebugElement.textContent = '(获取失败)';
								setTimeout(() => {
									ipDebugElement.textContent = '(双击获取位置)';
								}, 2000);
							}
						}
					} catch (geoError) {
						console.log('地理位置信息获取失败:', geoError);
						ipDebugElement.textContent = '(网络错误)';
						setTimeout(() => {
							ipDebugElement.textContent = '(双击获取位置)';
						}, 2000);
					}
				});
			}
		}
		
		// 更新IP版本显示样式
		if (ipVersionElement) {
			const ipVersion = ipVersionElement.textContent;
			if (ipVersion === 'IPv6') {
				ipVersionElement.classList.add('text-purple-500', 'dark:text-purple-400');
			} else if (ipVersion === 'IPv4') {
				ipVersionElement.classList.add('text-blue-500', 'dark:text-blue-400');
			}
		}
		
		// 如果当前是HTTPS，更新连接类型显示
		if (connectionTypeElement && window.location.protocol === 'https:') {
			const protocolSpan = connectionTypeElement.querySelector('span');
			if (protocolSpan && !protocolSpan.classList.contains('text-green-500')) {
				protocolSpan.innerHTML = `
					<svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
					</svg>
					<span class="text-green-500">HTTPS</span>
				`;
			}
		}
		
	} catch (error) {
		console.error('IP信息增强失败:', error);
	}
}

// 添加CSS动画
const style = document.createElement('style');
style.textContent = `
	@keyframes fade-in {
		from { opacity: 0; transform: translateY(-5px); }
		to { opacity: 1; transform: translateY(0); }
	}
	.animate-fade-in {
		animation: fade-in 0.3s ease-out;
	}
`;
document.head.appendChild(style);

// 页面加载时执行
document.addEventListener('DOMContentLoaded', enhanceIPInfo);

// 支持Swup页面切换
if (window.swup) {
	window.swup.hooks.on('page:view', enhanceIPInfo);
}
</script>